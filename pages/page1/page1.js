import form_input from '../../plugins/form_input/form_input.js';
import media from '../../plugins/media/media.js';
import form_datepicker from '../../plugins/form_datepicker/form_datepicker.js';
import title from '../../plugins/title/title.js';
import navigation from '../../plugins/navigation/navigation.js';
import form_options from '../../plugins/form_options/form_options.js';
import form_selector from '../../plugins/form_selector/form_selector.js';
import form_textarea from '../../plugins/form_textarea/form_textarea.js';
import category from '../../plugins/category/category.js';
import form_submit from '../../plugins/form_submit/form_submit.js';
var app = getApp();
var modrel={'form_input':form_input,'media':media,'form_datepicker':form_datepicker,'title':title,'navigation':navigation,'form_options':form_options,'form_selector':form_selector,'form_textarea':form_textarea,'category':category,'form_submit':form_submit};
var plugins={"layer8DA6584773CB219645C0688B2E25F89A":{"id":"layer8DA6584773CB219645C0688B2E25F89A","pid":"1","father_id":"layer153DEEF79731F029761330E123C56486","type":"form_input","left":20,"top":10,"width":100,"height":"auto","zindex":0,"globalstyle":{"background-image":"none","background-color":"transparent","background-repeat":"repeat","background-position":"top left","border-color":"transparent","border-style":"none","border-width":0,"border-radius":0},"childprop":{"inpval":"\u5355\u884c\u6587\u672c","inptype":"text","required":false,"style":{"margin-top":10},"text-align":"left","placeholder":{"color":"#ccc","font-size":12,"font-weight":"normal","text-decoration":"none","font-style":"normal","text-align":"left"},"inner_style":{"color":"#657180","background-color":"#fff","border-color":"#d7dde4","border-radius":4,"font-size":12,"font-weight":"normal","text-decoration":"none","font-style":"normal","text-align":"left","line-height":36,"margin-left":10,"padding-left":3,"padding-right":3,"height":36,"width":345},"modclick":{"type":"none","param":{"type":"","value":""}}}},"layer6C3ED3FA9D04560438CC39E49A95A442":{"id":"layer6C3ED3FA9D04560438CC39E49A95A442","pid":"1","father_id":"layer1959624D48943AFD7E739F52218810AB","type":"media","left":20,"top":26,"width":170,"height":184,"zindex":1,"globalstyle":{"background-image":"none","background-color":"transparent","background-repeat":"repeat","background-position":"top left","border-color":"transparent","border-style":"none","border-width":0,"border-radius":0},"childprop":{"src":"http:\/\/sitestar2.wopop.com\/upload\/hydrangeas_2_og66.jpg","text-align":"left","opacity":100,"border-radius":0,"modclick":{"type":"func","param":{"type":"product_list","value":"","pagevalue":"6","idsvalue":["1316","1826"],"title":""}}}},"layerB4829A958AE5080239E0903255E05FB1":{"id":"layerB4829A958AE5080239E0903255E05FB1","pid":"1","father_id":"layer153DEEF79731F029761330E123C56486","type":"form_datepicker","left":20,"top":10,"width":100,"height":"auto","zindex":1,"globalstyle":{"background-image":"none","background-color":"transparent","background-repeat":"repeat","background-position":"top left","border-color":"transparent","border-style":"none","border-width":0,"border-radius":0},"childprop":{"inpval":"\u65e5\u671f\u9009\u62e9\u5668","inptype":"date","required":false,"style":{"margin-top":10},"text-align":"left","inner_style":{"color":"#ccc","background-color":"#fff","border-color":"#d7dde4","border-radius":4,"font-size":12,"font-weight":"normal","text-decoration":"none","font-style":"normal","text-align":"left","line-height":36,"margin-left":10,"height":36,"width":345},"modclick":{"type":"none","param":{"type":"","value":""}}}},"layer74FDF35E63D966B5D3C8AC80A57100A6":{"id":"layer74FDF35E63D966B5D3C8AC80A57100A6","pid":"1","father_id":"layer1959624D48943AFD7E739F52218810AB","type":"title","left":209,"top":122,"width":100,"height":20,"zindex":3,"globalstyle":{"background-image":"none","background-color":"transparent","background-repeat":"repeat","background-position":"top left","border-color":"transparent","border-style":"none","border-width":0,"border-radius":0},"childprop":{"message":"\u4ea7\u54c1\u8be6\u60c5","style":{"color":"#666","font-size":12,"font-weight":"normal","font-style":"normal","text-decoration":"none","text-align":"left","line-height":1.4,"margin":0,"padding":0},"modclick":{"type":"func","param":{"type":"product_detail","value":"","pagevalue":"5","idsvalue":["259"],"title":"223232\u4ea7\u54c1\u540d\u79f0"}}}},"layer767CE2624BDB9EFD4C1358D71ACBB373":{"id":"layer767CE2624BDB9EFD4C1358D71ACBB373","pid":"1","father_id":"","type":"title","left":0,"top":0,"width":100,"height":"auto","zindex":3,"pageid":"1","globalstyle":{"background-image":"none","background-color":"transparent","background-repeat":"repeat","background-position":"top left","border-color":"transparent","border-style":"none","border-width":0,"border-radius":0},"childprop":{"message":"Text1 Text1","style":{"color":"#666","font-size":12,"font-weight":"normal","font-style":"normal","text-decoration":"none","text-align":"left","line-height":1.4,"margin":0,"padding":0}}},"layer0B0678D48780E949451EE2FEA692BD59":{"id":"layer0B0678D48780E949451EE2FEA692BD59","pid":"1","father_id":"layer1959624D48943AFD7E739F52218810AB","type":"title","left":207,"top":159,"width":100,"height":25,"zindex":4,"globalstyle":{"background-image":"none","background-color":"transparent","background-repeat":"repeat","background-position":"top left","border-color":"transparent","border-style":"none","border-width":0,"border-radius":0},"childprop":{"message":"\u6587\u7ae0\u8be6\u60c5","style":{"color":"#666","font-size":12,"font-weight":"normal","font-style":"normal","text-decoration":"none","text-align":"left","line-height":1.4,"margin":0,"padding":0},"modclick":{"type":"func","param":{"type":"article_detail","value":"","pagevalue":"4","idsvalue":["508"],"title":"\u65b0\u624b\u55d6\u55d6\u55d6"}}}},"layer1959624D48943AFD7E739F52218810AB":{"id":"layer1959624D48943AFD7E739F52218810AB","pid":"1","father_id":"","type":"freelayout","left":0,"top":0,"width":100,"height":"auto","zindex":5,"pageid":"1","globalstyle":{"background-image":"none","background-color":"transparent","background-repeat":"repeat","background-position":"top left","border-color":"transparent","border-style":"none","border-width":0,"border-radius":0},"childprop":{"height":230}},"layer61450DF1D0356B703B55D05E1621CA7E":{"id":"layer61450DF1D0356B703B55D05E1621CA7E","pid":"1","father_id":"layer1959624D48943AFD7E739F52218810AB","type":"title","left":211,"top":49,"width":100,"height":50,"zindex":5,"globalstyle":{"background-image":"none","background-color":"transparent","background-repeat":"repeat","background-position":"top left","border-color":"transparent","border-style":"none","border-width":0,"border-radius":0},"childprop":{"message":"\u6587\u7ae0\u5217\u8868","style":{"color":"#666","font-size":12,"font-weight":"normal","font-style":"normal","text-decoration":"none","text-align":"left","line-height":1.4,"margin":0,"padding":0},"modclick":{"type":"func","param":{"type":"article_list","value":"","pagevalue":"3","idsvalue":["72"],"title":""}}}},"layerDA5C0035D91A5EA956913EFC96A57701":{"id":"layerDA5C0035D91A5EA956913EFC96A57701","pid":"1","father_id":"layer1959624D48943AFD7E739F52218810AB","type":"navigation","left":265,"top":64,"width":100,"height":40,"zindex":6,"globalstyle":{"background-image":"none","background-color":"transparent","background-repeat":"repeat","background-position":"top left","border-color":"transparent","border-style":"none","border-width":0,"border-radius":0},"childprop":{"data_source":"define","linkto":"","items":[{"name":"\u65b0\u5bfc\u822a1","url":"#","modclick":[]},{"name":"\u65b0\u5bfc\u822a2","url":"#","modclick":[]}],"global":{"src":"http:\/\/sitestar2.wopop.com\/template\/default\/images\/navigation\/nav.png","marginTop":0,"marginBottom":10,"marginLeft":0,"marginRight":10,"background":"#88bd79"},"menu":{"background":"#88bd79","height":30},"title":{"color":"#fff","font-size":12,"font-weight":"normal","font-style":"normal","text-decoration":"none","line-height":30,"height":30}}},"layer773F9D059DEE044C5F56CE0CC2B2FA5C":{"id":"layer773F9D059DEE044C5F56CE0CC2B2FA5C","pid":"1","father_id":"layer153DEEF79731F029761330E123C56486","type":"form_input","left":20,"top":10,"width":100,"height":"auto","zindex":7,"globalstyle":{"background-image":"none","background-color":"transparent","background-repeat":"repeat","background-position":"top left","border-color":"transparent","border-style":"none","border-width":0,"border-radius":0},"childprop":{"inpval":"\u5355\u884c\u6587\u672c","inptype":"text","required":false,"style":{"margin-top":10},"text-align":"left","placeholder":{"color":"#ccc","font-size":12,"font-weight":"normal","text-decoration":"none","font-style":"normal","text-align":"left"},"inner_style":{"color":"#657180","background-color":"#fff","border-color":"#d7dde4","border-radius":4,"font-size":12,"font-weight":"normal","text-decoration":"none","font-style":"normal","text-align":"left","line-height":36,"margin-left":10,"padding-left":3,"padding-right":3,"height":36,"width":345},"modclick":{"type":"none","param":{"type":"","value":""}}}},"layerD93D5CA5741F3BDA1F62047710BEC968":{"id":"layerD93D5CA5741F3BDA1F62047710BEC968","pid":"1","father_id":"layer153DEEF79731F029761330E123C56486","type":"form_options","left":20,"top":10,"width":100,"height":"auto","zindex":8,"globalstyle":{"background-image":"none","background-color":"transparent","background-repeat":"repeat","background-position":"top left","border-color":"transparent","border-style":"none","border-width":0,"border-radius":0},"childprop":{"title":"\u6807\u9898","type":"radio","required":true,"options":[{"value":"123"},{"value":"234"},{"value":"456"}],"style":{"margin-top":10},"text-align":"left","inner_style":{"margin-left":10,"width":345},"title_style":{"background-color":"transparent","color":"#5c6b77","line-height":36,"font-size":12,"font-weight":"normal","text-decoration":"none","font-style":"normal"},"option_style":{"color":"#5c6b77","line-height":36,"font-size":12,"font-weight":"normal","text-decoration":"none","font-style":"normal"},"modclick":{"type":"none","param":{"type":"","value":""}}}},"layerA07BC4366CB316151731E24F0B6E3D09":{"id":"layerA07BC4366CB316151731E24F0B6E3D09","pid":"1","father_id":"layer153DEEF79731F029761330E123C56486","type":"form_selector","left":20,"top":10,"width":100,"height":"auto","zindex":9,"globalstyle":{"background-image":"none","background-color":"transparent","background-repeat":"repeat","background-position":"top left","border-color":"transparent","border-style":"none","border-width":0,"border-radius":0},"childprop":{"title":"\u8bf7\u9009\u62e9...","options":[{"value":"12"},{"value":"23"},{"value":"34"}],"required":true,"style":{"margin-top":10},"text-align":"left","inner_style":{"color":"#657180","background-color":"#fff","border-color":"#d7dde4","border-radius":4,"font-size":12,"font-weight":"normal","text-decoration":"none","font-style":"normal","margin-left":10,"text-align":"left","height":36,"width":345},"modclick":{"type":"none","param":{"type":"","value":""}}}},"layer9236F5DBB5F0729B0AEAD8D5EEFDC620":{"id":"layer9236F5DBB5F0729B0AEAD8D5EEFDC620","pid":"1","father_id":"","type":"title","left":0,"top":0,"width":100,"height":"auto","zindex":10,"pageid":"1","globalstyle":{"background-image":"none","background-color":"transparent","background-repeat":"repeat","background-position":"top left","border-color":"transparent","border-style":"none","border-width":0,"border-radius":0},"childprop":{"message":"\u6587\u7ae0\u8be6\u60c5","style":{"color":"#666","font-size":12,"font-weight":"normal","font-style":"normal","text-decoration":"none","text-align":"left","line-height":2.6,"margin":6,"padding":0},"modclick":{"type":"page","param":{"type":"page","value":"mydistribution","pagevalue":"3","idsvalue":["1316"],"title":""}}}},"layer4B3CACC04CD0F7A3DE707375E3D5B09C":{"id":"layer4B3CACC04CD0F7A3DE707375E3D5B09C","pid":"1","father_id":"layer153DEEF79731F029761330E123C56486","type":"form_textarea","left":20,"top":10,"width":100,"height":"auto","zindex":10,"globalstyle":{"background-image":"none","background-color":"transparent","background-repeat":"repeat","background-position":"top left","border-color":"transparent","border-style":"none","border-width":0,"border-radius":0},"childprop":{"inpval":"\u5bcc\u6587\u672c","style":{"margin-top":10},"text-align":"left","placeholder":{"color":"#ccc","font-size":12},"inner_style":{"color":"#657180","background-color":"#fff","border-color":"#d7dde4","border-radius":4,"font-size":12,"margin-left":10,"text-align":"left","height":64,"width":345},"modclick":{"type":"none","param":{"type":"","value":""}}}},"layerF3019CE326BA2863A3B353FED428DBA7":{"id":"layerF3019CE326BA2863A3B353FED428DBA7","pid":"1","father_id":"","type":"category","left":0,"top":0,"width":100,"height":"auto","zindex":11,"pageid":"1","globalstyle":{"background-image":"none","background-color":"transparent","background-repeat":"repeat","background-position":"top left","border-color":"transparent","border-style":"none","border-width":0,"border-radius":0},"childprop":{"data_source":{"type":"product","value":"All"},"linkto":"","global":{"margin":15,"background":"#eee"},"title":{"color":"#666560","selectedColor":"#88bd79","font-size":12,"font-weight":"normal","font-style":"normal","text-decoration":"none","line-height":40,"height":40},"border":{"style":"solid","width":2,"color":"transparent","selectedColor":"#88bd79"}}},"layer70AEFF248897E9C6AF219D3B88B4090D":{"id":"layer70AEFF248897E9C6AF219D3B88B4090D","pid":"1","father_id":"layer153DEEF79731F029761330E123C56486","type":"form_submit","left":20,"top":10,"width":100,"height":"auto","zindex":11,"globalstyle":{"background-image":"none","background-color":"transparent","background-repeat":"repeat","background-position":"top left","border-color":"transparent","border-style":"none","border-width":0,"border-radius":0},"childprop":{"btnval":"\u63d0 \u4ea4","style":{"margin-top":10},"text-align":"center","actived":{"color":"#495060","background-color":"#e0e0e0"},"inner_style":{"color":"#495060","background-color":"#f7f7f7","border-color":"#dddee1","border-radius":4,"font-size":12,"font-weight":"normal","text-decoration":"none","font-style":"normal","line-height":36,"margin-left":0,"height":36,"width":70},"submit_tips":"\u63d0\u4ea4\u6210\u529f","modclick":{"type":"none","param":{"type":"","value":""}}}},"layer153DEEF79731F029761330E123C56486":{"id":"layer153DEEF79731F029761330E123C56486","pid":"1","father_id":"","type":"form","left":0,"top":0,"width":100,"height":"auto","zindex":12,"pageid":"1","globalstyle":{"background-image":"none","background-color":"transparent","background-repeat":"repeat","background-position":"top left","border-color":"transparent","border-style":"none","border-width":0,"border-radius":0},"childprop":{"height":358,"tbl":"1528880568025lnv","title":"\u8868\u53551","modclick":{"type":"none","param":{"type":"","value":""}}}}};
var pageconf={
  data: {
    plugins:plugins,
	pageid: 'page1/page1',
	showBar: false,
	tabs: {}
  },
  onLoad: function(o){
    let curpage = this.data.pageid;
    let tabs = getApp().globalData.config.tabBar || {};
    if (tabs.list) {
      this.setData({tabs});
      let _has_ = tabs.list.findIndex(c => {
		const lnkid = c.pagePath;
        return lnkid == curpage
      });
      this.setData({
        showBar: _has_ > -1 ? true : false
      })
    }
  },
  viewtap: function(e){
    var layerid=e.currentTarget.dataset.layerid;
    var plugindata=this.data.plugins[layerid];
    if(plugindata){
      var modclick=plugindata.childprop.modclick;
      app.moduleBindTap(modclick);
    }
  },
  switchTab: function(e){
	let url = e.currentTarget.dataset.url;
	getApp().turnToPage(url, true)
  },
  formReset: function(form){
	if (!Array.isArray(form)) return false;
	form.forEach(c => {
	  let _default_ = null;
	  switch (typeof c.reval) {
		case 'string': _default_ = '';break;
		case 'number': _default_ = -1;break;
		case 'object':
		  _default_ = Array.isArray(c.reval)?[]:{};
		  break;
	  }
	  let newobj = {[`${c.id}._value_`]: _default_};
	  // for 'chooseImage'
	  const pluginobj = this.data[c.id]||{};
      if (pluginobj.isImageFile === true) {
		newobj[`${c.id}.showClear`] = false;
		newobj[`${c.id}.inptext`] = pluginobj.param.inpval
      }
	  this.setData(newobj)
	})
  },
  formSubmit: function(e){
    // 表单验证
	const frmid = e.currentTarget.dataset.id;
	let formId = e.detail.formId;
  console.log(formId, frmid);
	if (!/^[a-z0-9]+$/i.test(frmid)) return false;
	let errln = 0, formmap = [], uploading = [];
	const frmdata = e.detail.value;
	const image = '/static/icons/warning.png';
	if (! Object.keys(frmdata).length) return false;
	for (let k in frmdata) {
	  const dataobj = this.data[k];
	  formmap.push({id: k,reval: dataobj._value_});
	  if (dataobj.isUploading === true) uploading.push(k);
      if (true != dataobj.param.required||false) continue;
      if (frmdata[k].length == 0) {
        errln++;
        let newobj = {[`${k}.haswarn`]: true};
        this.setData(newobj)
      }
	}
	if (errln > 0) wx.showToast({title: '请先完善表单数据',image})
	else if (uploading.length > 0) {
      wx.showToast({title: '正在传送文件，请稍后再试',icon: 'none'})
	} else {
	  const self = this;
	  const submitips = e.detail.target.dataset.tips;
	  wx.showLoading({title: '处理中',mask: true});
	  app.apiRequest('form_submit', 'index', {
		method: 'POST',
		data: {frmid, frmdata: JSON.stringify(frmdata), formId},
		success (res){
		  wx.hideLoading();
		  if (res.data.result == 'ERROR') {
			wx.showToast({title: res.data.errmsg,image});
			return false
		  }
		  wx.showToast({
			title: submitips,
			icon: 'success',
			complete (){
			  self.formReset(formmap)
			}
		  })
		},
		fail (exp){
		  wx.showToast({
			title: exp.errMsg,
			icon: 'none',
			duration: 2500,
			complete (){
				wx.hideLoading()
			}
		  })
		},
	  })
	}
  },
	onShareAppMessage: function(res){}
}
for(var modid in plugins){
  (function(){
    var moddata=plugins[modid];
    var cls=modrel[moddata.type];
	if(cls){
		cls().install(pageconf, {scope:modid,
		static:{
		  param:moddata.childprop,
		  layerid: modid
		}
		})
	}
  })(modid)
}
Page(pageconf)


